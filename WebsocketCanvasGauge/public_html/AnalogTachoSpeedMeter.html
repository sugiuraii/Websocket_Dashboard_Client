<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <link rel="stylesheet" href="./css/default.css" type="text/css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="./script/libs/jquery/jquery.js"></script>
        <script src="./script/websocket/DefiCOM_WSTest.js"></script>
        <script src="./script/websocket/SSMCOM_WSTest.js"></script>
        <script src="./script/websocket/FUELTRIP_WSTest.js"></script>
        <script>
            var defi_ws = new DefiCOM_Websocket();
            var ssm_ws = new SSMCOM_Websocket();
            var fueltrip_ws = new FUELTRIP_Websocket();
            
            defi_ws.onVALpacketReceived = function(val)
            {
                for (var key in val)
                {
                    if(key === "Boost")
                    {
                        $("#gauge_frame1")[0].contentWindow.boost = val[key];
                    }
                    else if(key === "Tacho")
                    {
                        $("#gauge_frame1")[0].contentWindow.tacho = val[key];
                    }
                }
                $("#gauge_frame1")[0].contentWindow.value_update();
            };
            defi_ws.onERRpacketReceived = function(msg)
            {
                appendDebugMessage("Defi", msg);
            };
            defi_ws.onRESpacketReceived = function(msg)
            {
                appendDebugMessage("Defi", msg);
            };
            defi_ws.onWebsocketError = function(msg)
            {
                appendDebugMessage("Defi", msg);
            };
            defi_ws.onWebsocketOpen = function()
            {
                appendDebugMessage("Defi", "Connection started");
                setTimeout(
                function(){
                defi_ws.SendDefiWSSend("Boost","true");
                defi_ws.SendDefiWSSend("Tacho","true");
                },5000);
            };
            defi_ws.onWebsocketClose = function()
            {
                appendDebugMessage("Defi", "Connection closed");
                appendDebugMessage("Defi", "Reconnect after 5sec...");
                setTimeout(
                function(){
                    defi_ws.Connect();
                }, 5000);                
            };
            
            ssm_ws.onVALpacketReceived = function(val)
            {
                for (var key in val)
                {
                    if(key === "Coolant_Temperature")
                    {
                        $("#gauge_frame1")[0].contentWindow.watertemp = val[key];
                    }
                    else if (key === "Vehicle_Speed")
                    {
                        $("#gauge_frame1")[0].contentWindow.speed = val[key];
                    }
                    else if(key === "Neutral_Position_Switch")
                    {
                        if(val[key].toLowerCase() === "false")
                            $("#gauge_frame1")[0].contentWindow.neutral_sw = false;
                        else
                            $("#gauge_frame1")[0].contentWindow.neutral_sw = true;
                    }

                    $("#gauge_frame1")[0].contentWindow.value_update();
                }
            };
            ssm_ws.onERRpacketReceived = function(msg)
            {
                appendDebugMessage("SSM", msg);
            };
            ssm_ws.onRESpacketReceived = function(msg)
            {
                appendDebugMessage("SSM", msg);
            };
            ssm_ws.onWebsocketError = function(msg)
            {
                appendDebugMessage("SSM", msg);
            };
            ssm_ws.onWebsocketOpen = function()
            {
                appendDebugMessage("SSM", "Connection started");
                setTimeout(
                function(){
                ssm_ws.SendSSMCOMRead("Coolant_Temperature","SLOW","true");
                ssm_ws.SendSSMCOMRead("Vehicle_Speed","FAST","true");
                ssm_ws.SendSSMCOMRead("Vehicle_Speed","SLOW","true");
                ssm_ws.SendSSMCOMRead("Switch_P0x062","FAST","true");
                ssm_ws.SendSSMCOMRead("Switch_P0x062","SLOW","true");
                },5000);
            };
            ssm_ws.onWebsocketClose = function()
            {
                appendDebugMessage("SSM", "Connection closed");
                appendDebugMessage("SSM", "Reconnect after 5sec...");
                setTimeout(
                function(){
                    ssm_ws.Connect();
                }, 5000);                
            };
            
            fueltrip_ws.onMomentFUELTRIPpacketReceived = function(moment_gasmilage, total_gas, total_trip, total_gasmilage)
            {
                $("#gauge_frame1")[0].contentWindow.fuel = total_gas;
                $("#gauge_frame1")[0].contentWindow.trip = total_trip;
                $("#gauge_frame1")[0].contentWindow.gas_milage = total_gasmilage;
                $("#gauge_frame1")[0].contentWindow.value_update();
            };
            
            function appendDebugMessage(prefix,message)
            {
                var output_message = prefix + " : "  + message;
                $('#div_message').append(output_message + '<br/>');
            };
            
            fueltrip_ws.onWebsocketOpen = function()
            {
                appendDebugMessage("FUELTRIP", "Connection started");
            };
            
            fueltrip_ws.onWebsocketClose = function()
            {
                appendDebugMessage("FUETRIP", "Connection closed");
                appendDebugMessage("FUELTRIP", "Reconnect after 5sec...");
                setTimeout(
                function(){
                    fueltrip_ws.Connect();
                }, 5000);                
            };

            
            function connectWebSocket()
            {
                defi_ws.URL = "ws://"+location.hostname+":2012/";
                defi_ws.Connect();
                ssm_ws.URL = "ws://"+location.hostname+":2013/";
                ssm_ws.Connect();
                fueltrip_ws.URL = "ws://"+location.hostname+":2014/";
                fueltrip_ws.Connect();
            };
            
            function reset_fuel_trip()
            {
                if(window.confirm('Reset fuel and trip?'))
                {
                    fueltrip_ws.SendReset();
                };
            };
            
            function checkWebsocketStatus()
            {
                switch(defi_ws.getReadyState()) 
                { 
                    case 0://CONNECTING
                        $("#defi_status").css("color","blue");
                        break;
                    case 1://OPEN
                        $("#defi_status").css("color","green");
                        break;
                    case 2://CLOSING
                        $("#defi_status").css("color","orange");
                        break;
                    case 3://CLOSED
                        $("#defi_status").css("color","red");
                        break;
                    default:
                        // this never happens
                        break;                      
                };
                switch(ssm_ws.getReadyState()) 
                    {
                        case 0:
                            $("#ssm_status").css("color","blue");
                            break;
                        case 1:
                            $("#ssm_status").css("color","green");
                            break;
                        case 2:
                            $("#ssm_status").css("color","orange");
                            break;
                        case 3:
                            $("#ssm_status").css("color","red");
                            break;
                        default:
                            // this never happens
                            break;                      
                };
                switch(fueltrip_ws.getReadyState()) 
                {
                        case 0:
                            $("#fueltrip_status").css("color","blue");
                            break;
                        case 1:
                            $("#fueltrip_status").css("color","green");
                            break;
                        case 2:
                            $("#fueltrip_status").css("color","orange");
                            break;
                        case 3:
                            $("#fueltrip_status").css("color","red");
                            break;
                        default:
                            // this never happens
                            break;                      
                }
            };
            
            function show_debug_msg()
            {
                if($("#div_message").css("visibility") === "hidden")
                {
                    //Show debug message window
                    $("#div_message").css("visibility","visible");                    
                }
                else
                {
                    //Hide debug message window
                    $("#div_message").css("visibility","hidden");
                }
            }
            onload = function()
            {
                 connectWebSocket();
                 setInterval("checkWebsocketStatus()", 1000);
            };
            
        </script>
        <style>
            iframe.meter { 
                    position:relative;
                    border: none;
                    z-index:1;
                    /*
                    -webkit-transform:scale(1.2,1.2);
                    -moz-transform:scale(1.2,1.2);
                    -ms-transform:scale(1.2,1.2);
                    transform:scale(1.1,1.1);
                    */
                    
                    -webkit-transform-origin: 0 0;
                    -moz-transform-origin: 0 0;
                    -ms-transform-origin: 0 0;
                    transform-origin: 0 0;
                }
        </style>
    </head>
    <body> 
        <center>
            <iframe class="meter" id="gauge_frame1" src="./parts/AnalogMeterCluster/AnalogMeterCluster.html" scrolling="no" width="1060" height="600" seamless> </iframe><br>
        </center>
        <br>
        <div class="debug_message" id="div_message" ></div>
        <button id="button_reset" class="button1" onclick="reset_fuel_trip()" style="position:absolute;top:0px;right:0px">Reset</button>
        <button id="button_debug" class="button1" onclick="show_debug_msg()" style="position:absolute;top:80px;right:0px">Debug</button>
        <div class="websocket_statusBox" style="position:absolute;top:160px;right:0px">
            <div style="color:white">Websocket Status</div> 
            <div id="defi_status" style="color: red">Defi</div>
            <div id="ssm_status" style="color: red">SSM</div>
            <div id="fueltrip_status" style="color: red">FUELTRIP</div>
        </div>
    </body>
</html>
