<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>DigitalTachoCluster1</title>
        <link rel="stylesheet" href="./css/default.css" type="text/css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="./script/libs/jquery/jquery.js"></script>
        <script src="./script/websocket/DefiCOMWebsocket.js"></script>
        <script src="./script/websocket/SSMCOMWebsocket.js"></script>
        <script src="./script/websocket/FUELTRIPWebsocket.js"></script>
        <script src="./script/meterpanel-common.js"></script>
        <script>
            var defi_ws = new DefiCOM_Websocket();
            var ssm_ws = new SSMCOM_Websocket();
            
            setMeterDefault(defi_ws, ssm_ws, null);
            
            defi_ws.onVALpacketReceived = function(val)
            {
                for (var key in val)
                {
                    if(key === "Boost")
                    {
                        $("#frame_boost")[0].contentWindow.value = val[key];
                    }
                    else if(key === "Tacho")
                    {
                        $("#frame_tacho")[0].contentWindow.tacho = val[key];
                    }
                }
                $("#frame_boost")[0].contentWindow.value_update();
                $("#frame_tacho")[0].contentWindow.value_update();
            };
            defi_ws.onWebsocketOpen = function()
            {
                appendDebugMessage("Defi", "Connection started");
                setTimeout(
                function(){
                defi_ws.SendDefiWSSend("Boost","true");
                defi_ws.SendDefiWSSend("Tacho","true");
                defi_ws.SendDefiWSInterval(localStorage.defiWSInterval);
                $("#spinner_defiWSinterval").val(localStorage.defiWSInterval);
                },5000);
            };            
            ssm_ws.onVALpacketReceived = function(val)
            {
                for (var key in val)
                {
                    if (key === "Vehicle_Speed")
                    {
                        $("#frame_tacho")[0].contentWindow.speed = val[key];
                        
                    }
                    else if(key === "Neutral_Position_Switch")
                    {
                        if(val[key].toLowerCase() === "false")
                            $("#frame_tacho")[0].contentWindow.neutral_sw = false;
                        else
                            $("#frame_tacho")[0].contentWindow.neutral_sw = true;
                    }
                }
                $("#frame_tacho")[0].contentWindow.value_update();
            };
            ssm_ws.onWebsocketOpen = function()
            {
                appendDebugMessage("SSM", "Connection started");
                setTimeout(
                function(){
                ssm_ws.SendSSMCOMRead("Vehicle_Speed","FAST","true");
                ssm_ws.SendSSMCOMRead("Vehicle_Speed","SLOW","true");
                ssm_ws.SendSSMCOMRead("Switch_P0x062","FAST","true");
                ssm_ws.SendSSMCOMRead("Switch_P0x062","SLOW","true");
                },5000);
            };

            
            function initializeGaugeBoost()
            {
                var gauge_id = "#frame_boost";
                $(gauge_id)[0].contentWindow.value_max = 2.0;
                $(gauge_id)[0].contentWindow.value_min = -1.0;
                $(gauge_id)[0].contentWindow.title_str = "TURBO BOOST";
                $(gauge_id)[0].contentWindow.unit_str = "x100Pa";
                $(gauge_id)[0].contentWindow.scale_str1 ="-1.0";
                $(gauge_id)[0].contentWindow.scale_str2 ="-0.5";
                $(gauge_id)[0].contentWindow.scale_str3 = "0";
                $(gauge_id)[0].contentWindow.scale_str4 = "0.5";
                $(gauge_id)[0].contentWindow.scale_str5 = "1.0";
                $(gauge_id)[0].contentWindow.scale_str6 = "1.5";
                $(gauge_id)[0].contentWindow.scale_str7 = "2.0";
                $(gauge_id)[0].contentWindow.redzone_offset_angle = 315;
                $(gauge_id)[0].contentWindow.redzone_full_angle = 45;
                $(gauge_id)[0].contentWindow.greenzone_offset_angle = 90;
                $(gauge_id)[0].contentWindow.greenzone_full_angle = 90;
                $(gauge_id)[0].contentWindow.yellowzone_offset_angle = 270;
                $(gauge_id)[0].contentWindow.yellowzone_full_angle = 45;

                $(gauge_id)[0].contentWindow.value_label_rounded = 1;

                $(gauge_id)[0].contentWindow.redzone_enable = true;
                $(gauge_id)[0].contentWindow.yellowzone_enable = true;
                $(gauge_id)[0].contentWindow.greenzone_enable = true;

                $(gauge_id)[0].contentWindow.angle_resolution = 1;
                $(gauge_id)[0].contentWindow.invert_fill = false;
                $(gauge_id)[0].contentWindow.initialize();
            };
            
            onload = function()
            {
                initializeGaugeBoost();
                connectWebSocket(defi_ws, ssm_ws, null);
                setInterval("checkWebsocketStatus(defi_ws, ssm_ws, null)", 1000);
            };
            
            function onDefiWSIntervalChange()
            {
                var interval = $("#spinner_defiWSinterval").val();
                defi_ws.SendDefiWSInterval(interval);
                localStorage.defiWSInterval = interval;
            }
            
        </script>
        <style>
            iframe.meter { 
                    position:absolute;
                    border: none;
                    z-index:1;
                    transform:scale(0.5,0.5);                    
                    transform-origin: 0 0;
                }
        </style>
    </head>
    <body> 
        <iframe class="meter" style="top:0px;left:0px" id="frame_tacho" src="./parts/DigiTachoBar/DigiTachoBar.html" scrolling="no" width="1200" height="606" seamless> </iframe>
        <iframe class="meter" style="left:600px;top:0px;transform:scale(0.38)" id="frame_boost" src="./parts/FullCircularGauge/FullCircularGauge.html" scrolling="no" width="799" height="794" seamless> </iframe>

        <br>
        <div class="debug_message" id="div_message" ></div>
        <button id="button_reset" class="button1" onclick="reset_fuel_trip()" style="position:absolute;top:0px;right:0px">Reset</button>
        <button id="button_debug" class="button1" onclick="show_debug_msg()" style="position:absolute;top:80px;right:0px">Debug</button>
        <div class="websocket_statusBox" style="position:absolute;top:160px;right:0px">
            <div style="color:white">Websocket Status</div> 
            <div id="defi_status" style="color: red">Defi</div>
            <div id="ssm_status" style="color: red">SSM</div>
            <div style="color:white">DefiWSInterval<br><input style="background:black;color:white" id="spinner_defiWSinterval" type="number" min="0" max="10" step="1" value ="0" onchange="onDefiWSIntervalChange()"/> </div>
        </div>
    </body>
</html>
